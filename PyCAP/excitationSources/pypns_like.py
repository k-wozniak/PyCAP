from PyCAP.excitationSources.excitation_source import ExcitationSource
import numpy as np

class PyPnsLike(ExcitationSource):
    """ Generates identical SFAPs. for each CV.
    
    - Multiple sfap sources
    - Multiple creation delays
    - cv^2 relationship with voltage

    """
    original_samples_n: int = 0
    original_fs = 400e3 # Hz
    original_sfap = [
            4.93412798528041e-09, 5.34968019548769e-09, 5.81901748810302e-09, 6.34679593751446e-09, 6.93127091659485e-09, 7.56607775429111e-09, 8.24711277005999e-09, 8.97552600917321e-09, 9.75407931674136e-09, 1.05856198860010e-08, 1.14772633292151e-08, 1.24437009357571e-08, 1.35049166207716e-08, 1.46820299168745e-08, 1.59957728362177e-08, 1.74662316266144e-08, 1.91108507772464e-08, 2.09412203626011e-08, 2.29637125316025e-08, 2.51885665111288e-08, 2.76393094588306e-08, 3.03513673387662e-08, 3.33655168644147e-08, 3.67248999279197e-08, 4.04742365434227e-08, 4.46558685404730e-08, 4.93041245530121e-08, 5.44513988052832e-08, 6.01455311000603e-08, 6.64543067496188e-08, 7.34573322010470e-08, 8.12416562991224e-08, 8.99012377376396e-08, 9.95354774238166e-08, 1.10249315578320e-07, 1.22163974719911e-07, 1.35439280648390e-07, 1.50277990675596e-07, 1.66885442971374e-07, 1.85438179743644e-07, 2.06101275315250e-07, 2.29055958003610e-07, 2.54528839325251e-07, 2.82828229035271e-07, 3.14356648260496e-07, 3.49564636900836e-07, 3.88865490621098e-07, 4.32599338338093e-07, 4.81120091332210e-07, 5.34962323777580e-07, 5.94948995075364e-07, 6.62106477302702e-07, 7.37389068379422e-07, 8.21457591234867e-07, 9.14829307201819e-07, 1.01836429889365e-06, 1.13364581138986e-06, 1.26280024074053e-06, 1.40769800184180e-06, 1.56921052283140e-06, 1.74753950212845e-06, 1.94366486661936e-06, 2.16071397635493e-06, 2.40389156924717e-06, 2.67837782542169e-06, 2.98634331685183e-06, 3.32642475805334e-06, 3.69773306956820e-06, 4.10516990466042e-06, 4.56074900951365e-06, 5.07847444363993e-06, 5.66456974356205e-06, 6.31141052384802e-06, 7.00644868628157e-06, 7.75155558793353e-06, 8.57181066072117e-06, 9.50253298801118e-06, 1.05589933773176e-05, 1.17054889725973e-05, 1.28610821136366e-05, 1.39612431579660e-05, 1.50136247659908e-05, 1.60857736815517e-05, 1.72457378629986e-05, 1.84959583702340e-05, 1.97359267042178e-05, 2.08083961032032e-05, 2.16141515743751e-05, 2.21663109080753e-05, 2.25441440319322e-05, 2.28292671829173e-05, 2.30717020841148e-05, 2.32824366554101e-05, 2.34470448258250e-05, 2.35505867717954e-05, 2.35924331192895e-05, 2.35838785661526e-05, 2.35390058968763e-05, 2.34675786201350e-05, 2.33723343334587e-05, 2.32507619001019e-05, 2.30991844839002e-05, 2.29153345848628e-05, 2.26981980663401e-05, 2.24469105791501e-05, 2.21604708276958e-05, 2.18382135004761e-05, 2.14796367350659e-05, 2.10828516565134e-05, 2.06426946566084e-05, 2.01504614401194e-05, 1.95967288848043e-05, 1.89763282925234e-05, 1.82904674915950e-05, 1.75412603701133e-05, 1.67222422680457e-05, 1.58140973606672e-05, 1.47913554496302e-05, 1.36386305542270e-05, 1.23640031236378e-05, 1.09889540775176e-05, 9.51586699587365e-06, 7.90667214193017e-06, 6.09738053328963e-06, 4.04559283018056e-06, 1.78695881754612e-06, -5.58543980699336e-07, -2.87875193782328e-06, -5.17751763908165e-06, -7.57445969316704e-06, -1.02031651642075e-05, -1.30760165712913e-05, -1.59883388525208e-05, -1.85880801668524e-05, -2.06224357747417e-05, -2.20901170316731e-05, -2.31579550951501e-05, -2.40130374165380e-05, -2.47783953214747e-05, -2.54904933361393e-05, -2.61234932419938e-05, -2.66431377804274e-05, -2.70446778130287e-05, -2.73521205385324e-05, -2.75988638971750e-05, -2.78108076966280e-05, -2.79984234937519e-05, -2.81589881196481e-05, -2.82858097473894e-05, -2.83759323690943e-05, -2.84315423612505e-05, -2.84572789525904e-05, -2.84571235607279e-05, -2.84327778600843e-05, -2.83838137764265e-05, -2.83085668667271e-05, -2.82045747229228e-05, -2.80686632450583e-05, -2.78976319212891e-05, -2.76898184530932e-05, -2.74459795935761e-05, -2.71673630155481e-05, -2.68518009103219e-05, -2.64914136280028e-05, -2.60746774254754e-05, -2.55929730021351e-05, -2.50473906824783e-05, -2.44468347821930e-05, -2.37948467653036e-05, -2.30778332440486e-05, -2.22676432490345e-05, -2.13396786392512e-05, -2.02980735193257e-05, -1.91847866865329e-05, -1.80468717257553e-05, -1.68863263521470e-05, -1.56507102762596e-05, -1.42749487811260e-05, -1.27475988930159e-05, -1.11667124370058e-05, -9.71903112722033e-06, -8.55590216335799e-06, -7.69599232200122e-06, -7.05658719180491e-06, -6.53504557117275e-06, -6.05989771244921e-06, -5.60691890978003e-06, -5.18901686281335e-06, -4.82714322861740e-06, -4.52653259039037e-06, -4.27490685119611e-06, -4.05313683581565e-06, -3.84531540491839e-06, -3.64397155182088e-06, -3.44967742059515e-06, -3.26614633383329e-06, -3.09531570212082e-06, -2.93583892121986e-06, -2.78432452075435e-06, -2.63730406223762e-06, -2.49268907884445e-06, -2.35012255938690e-06, -2.21024828238683e-06, -2.07368432625619e-06, -1.94046286644241e-06, -1.81005014485042e-06, -1.68167909093131e-06, -1.55473269037230e-06, -1.42897965246678e-06, -1.30453761172239e-06, -1.18164619638506e-06, -1.06046527190607e-06, -9.41009629993873e-07, -8.23195997764598e-07, -7.06935501332608e-07, -5.92206635510426e-07, -4.79067349926587e-07, -3.67614983167885e-07, -2.57936016583605e-07, -1.50077505678704e-07, -4.40496813753254e-08, 6.01466881522996e-08, 1.62492791603746e-07, 2.62947102627889e-07, 3.61454623959315e-07, 4.57950375144698e-07, 5.52354445391981e-07, 6.44575280458165e-07, 7.34535337795640e-07, 8.22193517338543e-07, 9.07536364055318e-07, 9.90558549249825e-07, 1.07125682409270e-06, 1.14963390338539e-06, 1.22569706386493e-06, 1.29944698658486e-06, 1.37087177828221e-06, 1.43995356866198e-06, 1.50667695029660e-06, 1.57103273096234e-06, 1.63301852101037e-06, 1.69263770697453e-06, 1.74989733033135e-06, 1.80480625520500e-06, 1.85737471084862e-06, 1.90761482623983e-06, 1.95554139694071e-06, 2.00117240920639e-06, 2.04452885099103e-06, 2.08563367359176e-06, 2.12451081973489e-06, 2.16118551283242e-06, 2.19568589289997e-06, 2.22804476081238e-06, 2.25829884252158e-06, 2.28648424191260e-06, 2.31263279743685e-06, 2.33677472133090e-06, 2.35894602779391e-06, 2.37919677379122e-06, 2.39759477927016e-06, 2.41421556832171e-06, 2.42912279621088e-06, 2.44236348817507e-06, 2.45397790015544e-06, 2.46399915549335e-06, 2.47243722385139e-06, 2.47926833113250e-06, 2.48445902830899e-06, 2.48801136129494e-06, 2.48997447987951e-06, 2.49042074279508e-06, 2.48942762236186e-06, 2.48707842116483e-06, 2.48346359647681e-06, 2.47866446784072e-06, 2.47273387724529e-06, 2.46569992572386e-06, 2.45758467238514e-06, 2.44841920384135e-06, 2.43825084586916e-06, 2.42713996362611e-06, 2.41514469693197e-06, 2.40230780247142e-06, 2.38865993632409e-06, 2.37423343219509e-06, 2.35907569234990e-06, 2.34325504895023e-06, 2.32685011254168e-06, 2.30992778783726e-06, 2.29253595734503e-06, 2.27471262677620e-06, 2.25648730166989e-06, 2.23786752009870e-06, 2.21883082698671e-06, 2.19935045817064e-06, 2.17943879883443e-06, 2.15915487442346e-06, 2.13857338253548e-06, 2.11775077357361e-06, 2.09670474803142e-06, 2.07541745449385e-06, 2.05387013779537e-06, 2.03207601384504e-06, 2.01007550651920e-06, 1.98791771482758e-06, 1.96565890898833e-06, 1.94337276415935e-06, 1.92114555822408e-06, 1.89904532366401e-06, 1.87709951528431e-06, 1.85530680518968e-06, 1.83366126081389e-06, 1.81216805181360e-06, 1.79084872164143e-06, 1.76973555299247e-06, 1.74885758902536e-06, 1.72823146680659e-06, 1.70786404720935e-06, 1.68776040158326e-06, 1.66793060357880e-06, 1.64839230874132e-06, 1.62916658364344e-06, 1.61026973737745e-06, 1.59170995343680e-06, 1.57349129438333e-06, 1.55561964228867e-06, 1.53810580745567e-06, 1.52096332545831e-06, 1.50420210384224e-06, 1.48782630044830e-06, 1.47183904392782e-06, 1.45624432160753e-06, 1.44104106799697e-06, 1.42621508339270e-06, 1.41174068870665e-06, 1.39759722824378e-06, 1.38378359823886e-06, 1.37031357068514e-06, 1.35719674458563e-06, 1.34441744050104e-06, 1.33192482156141e-06, 1.31965180024583e-06, 1.30755234759065e-06, 1.29561439249227e-06, 1.28384524151006e-06, 1.27226281233051e-06, 1.26090268174544e-06, 1.24981942887055e-06, 1.23905913902034e-06, 1.22862708311030e-06, 1.21849231497713e-06, 1.20861392522300e-06, 1.19895697619978e-06, 1.18949537113258e-06, 1.18020991044750e-06, 1.17108531625730e-06, 1.16210714858236e-06, 1.15326006241016e-06, 1.14452910078580e-06, 1.13590425939488e-06, 1.12738475877776e-06, 1.11897523136214e-06, 1.11067296412824e-06, 1.10246091076558e-06, 1.09431505512475e-06, 1.08621866654507e-06, 1.07817585499169e-06, 1.07021554143255e-06, 1.06237306424068e-06, 1.05466213162441e-06, 1.04707109722344e-06, 1.03957830159112e-06, 1.03215813359866e-06, 1.02477380146772e-06, 1.01737389394558e-06, 1.00990874711949e-06, 1.00235272697515e-06, 9.94705789287750e-07, 9.86981314539675e-07, 9.79200892556643e-07, 9.71397172913149e-07, 9.63609299173841e-07, 9.55863955315203e-07, 9.48164267273040e-07, 9.40499935074361e-07, 9.32858047094145e-07, 9.25220650128252e-07, 9.17557840254480e-07, 9.09834011890040e-07, 9.02028402099332e-07, 8.94144350619309e-07, 8.86198350234960e-07, 8.78206727495555e-07, 8.70179461459147e-07, 8.62119280970202e-07, 8.54024513556818e-07, 8.45893925881073e-07, 8.37729447499142e-07, 8.29535597649601e-07, 8.21317886019916e-07, 8.13081669545024e-07, 8.04831433443067e-07, 7.96570450318055e-07, 7.88301318742932e-07, 7.80027000035654e-07, 7.71750888593187e-07, 7.63475435663817e-07, 7.55200496396010e-07, 7.46923780690714e-07, 7.38644262587436e-07, 7.30364829669051e-07, 7.22091262428725e-07, 7.13829466463540e-07, 7.05583122080034e-07, 6.97352667225561e-07, 6.89136869112261e-07, 6.80936262459288e-07, 6.72754514515180e-07, 6.64596613032814e-07, 6.56466430253139e-07, 6.48365251916834e-07, 6.40292016660651e-07, 6.32245804623722e-07, 6.24228099784592e-07, 6.16241940398156e-07, 6.08290326469663e-07, 6.00376723997910e-07, 5.92506865553774e-07, 5.84689080847426e-07, 5.76931302807648e-07, 5.69237698267169e-07, 5.61608712516460e-07, 5.54042881119582e-07, 5.46537580515315e-07, 5.39088941684756e-07, 5.31693019133976e-07, 5.24348347865106e-07, 5.17056475534475e-07, 5.09819697731454e-07, 5.02639241374675e-07, 4.95515377296054e-07, 4.88448463257096e-07, 4.81439330280114e-07, 4.74488117399674e-07, 4.67592807222561e-07, 4.60750075772940e-07, 4.53959543299624e-07, 4.47229670901559e-07, 4.40579393481217e-07, 4.34029047576179e-07, 4.27587855239559e-07, 4.21252378321160e-07, 4.15013629667719e-07, 4.08862487070600e-07, 4.02791128886195e-07, 3.96794067196151e-07, 3.90870440245148e-07, 3.85024031708702e-07, 3.79259807866813e-07, 3.73580472196945e-07, 3.67984011128346e-07, 3.62462419394925e-07, 3.57004954478557e-07, 3.51605655356333e-07, 3.46266647559408e-07, 3.40994293815839e-07, 3.35793892822409e-07, 3.30666175439826e-07, 3.25606402177918e-07, 3.20607728962062e-07, 3.15666758653558e-07, 3.10785161865552e-07, 3.05966731206992e-07, 3.01213714466913e-07, 2.96524438474368e-07, 2.91893377720298e-07, 2.87314469057472e-07, 2.82784530342263e-07, 2.78303336879054e-07, 2.73872509871890e-07, 2.69496074313358e-07, 2.65181783645130e-07, 2.60939504583107e-07, 2.56775866415566e-07, 2.52691472451185e-07, 2.48683270897366e-07, 2.44746599450939e-07, 2.40874042493859e-07, 2.37054008330745e-07, 2.33273814348327e-07, 2.29525953518763e-07, 2.25809502141830e-07, 2.22126626917910e-07, 2.18481156063059e-07, 2.14880845437794e-07, 2.11338605928319e-07, 2.07867337408255e-07, 2.04472341007010e-07, 2.01150683870961e-07, 1.97895950084071e-07, 1.94701406789120e-07, 1.91560380182462e-07, 1.88466794089126e-07, 1.85417430551128e-07, 1.82412835386066e-07, 1.79455135047576e-07, 1.76545959744449e-07, 1.73686017194715e-07, 1.70875344830347e-07, 1.68113846713869e-07, 1.65402116989044e-07, 1.62741829043866e-07, 1.60135116591770e-07, 1.57582915329039e-07, 1.55082441913015e-07, 1.52625835653248e-07, 1.50203843619649e-07, 1.47812842261115e-07, 1.45456655526410e-07, 1.43141572183768e-07, 1.40869792856479e-07, 1.38634321066081e-07, 1.36418683457214e-07, 1.34205278026131e-07, 1.31985143582150e-07, 1.29758250900027e-07, 1.27529427105636e-07, 1.25309326552590e-07, 1.23119049638358e-07, 1.20987799707971e-07, 1.18938307277533e-07, 1.16976109635139e-07, 1.15094629608787e-07, 1.13282866571176e-07, 1.11524791788341e-07, 1.09795681669362e-07, 1.08067680994356e-07, 1.06324727948161e-07, 1.04568006901607e-07, 1.02806856405327e-07, 1.01049915630713e-07, 9.93034847741602e-08, 9.75733350907222e-08, 9.58648626806093e-08, 9.41804364686618e-08, 9.25175733587511e-08, 9.08707992033095e-08, 8.92362141747239e-08, 8.76163552478699e-08, 8.60214228399905e-08, 8.44629130396550e-08, 8.29447315825796e-08, 8.14616209357627e-08, 8.00042900479610e-08, 7.85651668918389e-08, 7.71420833348880e-08, 7.57382022184388e-08, 7.43570352646626e-08, 7.29970112278694e-08, 7.16517079492392e-08, 7.03156863495428e-08, 6.89924266591862e-08, 6.76992811284697e-08, 6.64612138296494e-08, 6.52949610911147e-08, 6.42020317167348e-08, 6.31751151936314e-08, 6.22034794831023e-08, 6.12710889085408e-08, 6.03546467966277e-08, 5.94315384740572e-08, 5.84924189135015e-08, 5.75422053818327e-08, 5.65913911998324e-08, 5.56497831937960e-08, 5.47250407081012e-08, 5.38225169245169e-08, 5.29446707782026e-08, 5.20917647583336e-08, 5.12640808793176e-08, 5.04623290644156e-08, 4.96849924696897e-08, 4.89251930751751e-08, 4.81719248176587e-08, 4.74170154121765e-08, 4.66599827964887e-08, 4.59056232024439e-08, 4.51591655706946e-08, 4.44231981361042e-08, 4.36967111048671e-08, 4.29763623384079e-08, 4.22591927316809e-08, 4.15441437809704e-08, 4.08318430386157e-08, 4.01245423161542e-08, 3.94268676730209e-08, 3.87457232269675e-08, 3.80873966521228e-08, 3.74543377811384e-08, 3.68457351323209e-08, 3.62597015258814e-08, 3.56932051971098e-08, 3.51402427464365e-08, 3.45919877667848e-08, 3.40413107571983e-08, 3.34869044423465e-08, 3.29317911315716e-08, 3.23792604784133e-08, 3.18302747552804e-08, 3.12827164093395e-08, 3.07321779087793e-08, 3.01738131058757e-08, 2.96035247112688e-08, 2.90184556637773e-08, 2.84192640439022e-08, 2.78149546498265e-08, 2.72256169996548e-08, 2.66746112355991e-08, 2.61739513684203e-08, 2.57207915871568e-08, 2.53058017301621e-08, 2.49193328443949e-08, 2.45512837212754e-08, 2.41901252706529e-08, 2.38263556235323e-08, 2.34572559671974e-08, 2.30861202995480e-08, 2.27178259160960e-08, 2.23556883694817e-08, 2.20003494486095e-08, 2.16502219676598e-08, 2.13034054557949e-08, 2.09594844596511e-08, 2.06195519591183e-08, 2.02851441186819e-08, 1.99572522195275e-08, 1.96357747964855e-08, 1.93196913441337e-08, 1.90080031894953e-08, 1.87005475838871e-08, 1.83979710483189e-08, 1.81011806477664e-08, 1.78107492310924e-08, 1.75265385121228e-08, 1.72478608141989e-08, 1.69741909216797e-08, 1.67057295673438e-08, 1.64432454340963e-08, 1.61873481566792e-08, 1.59376638345519e-08, 1.56926334714221e-08, 1.54505755730941e-08, 1.52110848016161e-08, 1.49751430434608e-08, 1.47440955278980e-08, 1.45184429015938e-08, 1.42969977798172e-08, 1.40772039729350e-08, 1.38568961064020e-08, 1.36356329337784e-08, 1.34142892004559e-08, 1.31941057487773e-08, 1.29762093928628e-08, 1.27613908386517e-08, 1.25497204973282e-08, 1.23402901355339e-08, 1.21317736751002e-08, 1.19235812686938e-08, 1.17169907044901e-08, 1.15160323846896e-08, 1.13271304053716e-08, 1.11563593075826e-08, 1.10069656464935e-08, 1.08801618405083e-08, 1.07757106165039e-08, 1.06886309512743e-08, 1.06043188700425e-08, 1.04998624677292e-08, 1.03559309380849e-08, 1.01666232779763e-08, 9.93602786765638e-09, 9.67135330186739e-09, 9.38262869549029e-09, 9.08589500147113e-09, 8.80010032635064e-09, 8.53569040818395e-09, 8.28880169691309e-09, 8.04808701296821e-09, 7.80519278982535e-09, 7.56243666171127e-09, 7.33490773702849e-09, 7.14218533277389e-09, 6.99502288765248e-09, 6.89243241239263e-09, 6.82766545421181e-09, 6.79049504148804e-09, 6.76381947406378e-09, 6.72307162814597e-09, 6.64596993586979e-09, 6.52331463890050e-09, 6.35767800452999e-09, 6.15728621349380e-09, 5.93602504586589e-09, 5.71715377556752e-09, 5.52922477300123e-09, 5.39103413943647e-09, 5.30397336816071e-09, 5.26020935947867e-09, 5.25034268120846e-09, 5.26171953131300e-09, 5.27438440880682e-09, 5.26582763252322e-09, 5.22371966350861e-09, 5.15027911660114e-09, 5.05454947711740e-09, 4.94460278608465e-09, 4.82512263483339e-09, 4.69819123802824e-09, 4.56464700699269e-09, 4.42445016548099e-09, 4.27617653461257e-09, 4.11754295114311e-09, 3.94793172904658e-09, 3.77160332050454e-09, 3.59783167296220e-09, 3.43499824812080e-09, 3.28418920977434e-09, 3.13983288348869e-09, 2.99528868898005e-09, 2.84846217598245e-09, 2.70509848232839e-09, 2.57658448777652e-09, 2.47199007447492e-09, 2.39282548748121e-09, 2.33520875114165e-09, 2.29373190506650e-09, 2.26273207867485e-09, 2.23632719435193e-09, 2.21014382108673e-09, 2.18388981564624e-09, 2.16083402585724e-09, 2.14476866360904e-09, 2.13739981174455e-09, 2.13660614700885e-09, 2.13642154439018e-09, 2.13065967305483e-09, 2.11751563356816e-09, 2.09983926446119e-09, 2.08193372472156e-09, 2.06648105637678e-09, 2.05273465735431e-09, 2.03669134850376e-09, 2.01393994683287e-09, 1.98273440495218e-09, 1.94419809003586e-09, 1.90062163531138e-09, 1.85414648540433e-09, 1.80630382930827e-09, 1.75776142521059e-09, 1.70807840599940e-09, 1.65599144304489e-09, 1.60028471152256e-09, 1.54086416126515e-09, 1.47990625720582e-09, 1.42224003564136e-09, 1.37334082572023e-09, 1.33611154368445e-09, 1.31025455794589e-09, 1.29399835307055e-09, 1.28509341810597e-09, 1.28037528195484e-09, 1.27565669291190e-09, 1.26754934578346e-09, 1.25545252359513e-09, 1.24107671606783e-09, 1.22660516811672e-09, 1.21337029541269e-09, 1.20128077957918e-09, 1.18908034290310e-09, 1.17555244004643e-09, 1.16059818954960e-09, 1.14511250996357e-09, 1.13009098038920e-09, 1.11574697571061e-09, 1.10106962619918e-09, 1.08430847416545e-09, 1.06419461229379e-09, 1.04055113292883e-09, 1.01389831219709e-09, 9.85014794583235e-10, 9.54947867716138e-10, 9.25068350963744e-10, 8.96575274106450e-10, 8.69784133859017e-10, 8.44149670236055e-10, 8.18904996620721e-10, 7.93640876167943e-10, 7.68619460687270e-10, 7.44687245807765e-10, 7.22654024754095e-10
        ] # V

    SFAP: np.ndarray

    base_voltage = 0
    micro = 10e-6

    def __init__(self, time_series: np.ndarray):
        self.start = 1
        self.is_continuous = False

        self.SFAP = np.array([self.get_sfap_function(x) for x in time_series])

    def get_sfap(self, velocity: float, time_shift: int = 1) -> np.ndarray:
        """ Returns the same SFAP for each velocity """
        temp = np.pad(self.SFAP, (time_shift, 0), 'constant', constant_values=(self.base_voltage, self.base_voltage))
        temp = temp[:-time_shift]

        return temp * (velocity ** 2)

    def get_sfap_function(self, ts):
        total_time = len(self.original_sfap) * 1/self.original_fs

        if ts <= 0 or ts >= total_time:
            return self.base_voltage

        return self.original_sfap[int(ts*self.original_fs)]


